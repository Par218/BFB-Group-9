{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <!--row for cards-->
                <div class="row">
                    <h3 style="margin-top: 1vh;">Dashboard</h3>
                    <!--Revenue card-->
                    <div class="col-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9">
                                        <h6>Total revenue</h6>
                                        <h4>R{{ "{:,.2f}".format(total_revenue | default(0)) }}</h4>
                                        <p style=" font-size:2vh; color:lightgreen;">
                                            {{ "+" if revenue_change|default(0) >= 0 }}{{ revenue_change|default(0) }}% from last month
                                        </p>
                                    </div>
                                    <div class="col-3">
                                        <img src="/static/Pictures/money-bag-south-african-rand-icon.png" class="img-fluid" alt="revenue icon">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Products sold card-->
                    <div class="col-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9">
                                        <h6>Products Sold</h6>
                                        <h4>{{ "{:,}".format(products_sold | default(0)) }}</h4>
                                        <p style="color: lightgreen; font-size: 2vh;">
                                            {{ "+" if products_sold_change|default(0) >= 0 }}{{ products_sold_change|default(0) }}% from last month
                                        </p>
                                    </div>
                                    <div class="col-3">
                                        <img src="/static/Pictures/shopping basket.svg" class="img-fluid" alt="products sold icon">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Manufacturing Jobs-->
                    <div class="col-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9">
                                        <h6>Complete Jobs</h6>
                                        <h4>{{ complete_jobs | default(0) }}</h4>
                                        <p style="color: lightgreen; font-size: 2vh;">
                                            {{ "+" if jobs_change|default(0) >= 0 }}{{ jobs_change|default(0) }}% from last month
                                        </p>
                                    </div>
                                    <div class="col-3">
                                        <img src="/static/Pictures/order_approve_56dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.svg" class="img-fluid" alt="complete jobs icon">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Active Orders-->
                    <div class="col-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-9">
                                        <h6>Active orders</h6>
                                        <h4>{{ active_orders | default(0) }}</h4>
                                        <p style="color: red; font-size: 2vh;">
                                            {{ "+" if orders_change|default(0) >= 0 }}{{ orders_change|default(0) }}% from last month
                                        </p>
                                    </div>
                                    <div class="col-3">
                                        <img src="{{ url_for('static', filename='Pictures/order_play_56dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.svg') }}" class="img-fluid" alt="active orders icon">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!--graph and quick actions-->
                <div class="row "  >
                    <div class="col-9">
                        <h4 class="mb-3">Sales vs Production Overview</h4>
                        <div class="card shadow-sm">
                            <div class="card-body" style="height: 400px;">
                                <canvas id="overviewChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-3">
                        <h4 class="mb-3">Quick Actions</h4>
                        <div class="vstack gap-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary quick-action-btn" data-bs-toggle="modal"
                                        data-bs-target="#Invoice-modal">
                                        <img src="{{ url_for('static', filename='Pictures/add_notes_64dp_000000_FILL0_wght400_GRAD0_opsz48.svg') }}"
                                            height="30" class="mb-2">
                                        <span style="font-size: 1.8vh;">Invoice</span>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary quick-action-btn" data-bs-toggle="modal"
                                        data-bs-target="#Stock-modal">
                                        <img src="{{ url_for('static', filename='Pictures/box_add_64dp_000000_FILL0_wght400_GRAD0_opsz48.svg') }}"
                                            height="30" class="mb-2">
                                        <span style="font-size: 1.8vh;">Stock</span>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary quick-action-btn" data-bs-toggle="modal"
                                        data-bs-target="#Customer-modal">
                                        <img src="{{ url_for('static', filename='Pictures/person_add_64dp_000000_FILL0_wght400_GRAD0_opsz48.svg') }}"
                                            height="30" class="mb-2">
                                        <span style="font-size: 1.8vh;">Customer</span>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary quick-action-btn" data-bs-toggle="modal"
                                        data-bs-target="#Report-modal">
                                        <img src="{{ url_for('static', filename='Pictures/add_chart_64dp_000000_FILL0_wght400_GRAD0_opsz48.svg') }}"
                                            height="30" class="mb-2">
                                        <span style="font-size: 1.8vh;">Report</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <div class="row mt-4 mb-5">
                        <h4>Recent Orders</h4>
                        <div class="card shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order #</th>
                                            <th>Client</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th class="text-end">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if recent_orders %}
                                        {% for order in recent_orders %}
                                        <tr>
                                            <td class="fw-bold">{{ order.order_number }}</td>
                                            <td>{{ order.client_name }}</td>
                                            <td>{{ order.created_at[:10] if order.created_at else 'N/A' }}</td>
                                            <td>R{{ "{:,.2f}".format(order.total_amount) }}</td>
                                            <td class="text-end">
                                                {% set status_class = {'pending': 'bg-warning', 'confirmed': 'bg-info', 'shipped':
                                                'bg-primary', 'delivered': 'bg-success', 'cancelled': 'bg-danger'} %}
                                                <span class="badge {{ status_class.get(order.status, 'bg-secondary') }} rounded-pill">{{
                                                    order.status|title }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">No recent orders found.</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="Invoice-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                        aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5">Create Invoice</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('create_invoice') }}">
                                    <div class="modal-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Invoice Number</label>
                                                <input type="text" class="form-control"
                                                    value="INV-{{ datetime.now().strftime('%Y%m%d') }}-AUTO" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Date</label>
                                                <input type="date" class="form-control" value="{{ datetime.now().strftime('%Y-%m-%d') }}"
                                                    readonly>
                                            </div>
                                        </div>
                    
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <h5>Customer Information</h5>
                                                <div class="row">
                                                    <div class="col-8">
                                                        <label for="customerSelect" class="form-label">Select Customer *</label>
                                                        <select class="form-select" id="customerSelect" name="customer_id" required>
                                                            <option value="">Select a customer...</option>
                                                            {% for customer in customers %}
                                                            <option value="{{ customer.customer_id }}">
                                                                {{ customer.name }} {% if customer.email %}({{ customer.email }}){% endif %}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-4 d-flex align-items-end">
                                                        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                                                            data-bs-target="#Customer-modal">
                                                            + Add New Customer
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                    
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <h5>Products</h5>
                                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                    <table class="table table-sm">
                                                        <thead class="table-light sticky-top">
                                                            <tr>
                                                                <th>Product</th>
                                                                <th>Price</th>
                                                                <th>Stock</th>
                                                                <th>Qty</th>
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for product in products %}
                                                            {% if product.quantity > 0 %}
                                                            <tr>
                                                                <td>
                                                                    <strong>{{ product.product_name }}</strong><br>
                                                                    <small class="text-muted">{{ product.sku }}</small>
                                                                </td>
                                                                <td>R{{ "%.2f"|format(product.price) }}</td>
                                                                <td><span class="badge bg-secondary">{{ product.quantity }}</span></td>
                                                                <td style="width: 100px;">
                                                                    <input type="number" class="form-control form-control-sm item-quantity"
                                                                        name="product_{{ product.product_id }}" value="0" min="0"
                                                                        max="{{ product.quantity }}" data-price="{{ product.price }}"
                                                                        onchange="calculateItemTotal(this)">
                                                                </td>
                                                                <td class="item-total">R 0.00</td>
                                                            </tr>
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                    
                                        <div class="row mt-3">
                                            <div class="col-12 text-end">
                                                <h4>Total: <span id="invoiceTotal">R 0.00</span></h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Generate Invoice</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="Customer-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5">Add New Customer</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('add_customer') }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="customerName" class="form-label">Customer Name *</label>
                                            <input type="text" class="form-control" id="customerName" name="customerName" required
                                                placeholder="e.g. Acme Corp">
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label for="customerEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="customerEmail" name="customerEmail"
                                                    placeholder="name@example.com">
                                            </div>
                                            <div class="col-6">
                                                <label for="customerPhone" class="form-label">Phone</label>
                                                <input type="tel" class="form-control" id="customerPhone" name="customerPhone"
                                                    placeholder="+27...">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerAddress" class="form-label">Address</label>
                                            <textarea class="form-control" id="customerAddress" name="customerAddress" rows="2"></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Save Customer</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="Stock-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5">Add New Product</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('add_stock') }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Product Name *</label>
                                            <input type="text" class="form-control" name="stockName" required>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Category *</label>
                                                <div class="input-group">
                                                    <select class="form-select" name="stockCategory" required>
                                                        <option value="">Select...</option>
                                                        {% for category in categories %}
                                                        <option value="{{ category.category_id }}">{{ category.category_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                                                        data-bs-target="#Category-modal">+</button>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Quantity *</label>
                                                <input type="number" class="form-control" name="stockQuantity" value="10" min="0" required>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Cost Price (R)</label>
                                                <input type="number" class="form-control" name="stockCostPrice" step="0.01" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Sell Price (R)</label>
                                                <input type="number" class="form-control" name="stockSellPrice" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Add Product</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="Category-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5">Add Category</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('add_category') }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Category Name *</label>
                                            <input type="text" class="form-control" name="categoryName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" name="categoryDescription" rows="2"></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                                            data-bs-target="#Stock-modal">Back</button>
                                        <button type="submit" class="btn btn-primary">Save Category</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal fade" id="Report-modal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Generate Report</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('generate_report') }}">
                                    <div class="modal-body">
                                        <select class="form-select mb-3" name="reportType">
                                            <option value="1">Sales Report</option>
                                            <option value="2">Inventory Report</option>
                                        </select>
                                        <div class="row">
                                            <div class="col-6"><input type="date" class="form-control" name="startDate" required></div>
                                            <div class="col-6"><input type="date" class="form-control" name="endDate" required></div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">Generate</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

 <script>
    // === CHART JS IMPLEMENTATION ===
    const ctx = document.getElementById('overviewChart');

    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Products Sold', 'Active Orders', 'Completed Jobs'],
                datasets: [{
                    label: 'Current Month Activity',
                    // Flask injects the data here:
                    data: [{{ products_sold|default(0) }}, {{ active_orders|default(0) }}, {{ complete_jobs |default (0) }}],

                    backgroundColor: [
                        'rgba(54, 162, 235, 0.6)', // Blue
                        'rgba(255, 206, 86, 0.6)', // Yellow
                        'rgba(75, 192, 192, 0.6)'  // Teal
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Hiding legend since labels explain the data
                    }
                }
            }
        });
    }

                    function calculateItemTotal(input) {
                        const qty = parseInt(input.value) || 0;
                        const price = parseFloat(input.dataset.price);
                        const row = input.closest('tr');
                        row.querySelector('.item-total').textContent = 'R ' + (qty * price).toFixed(2);
                        calculateInvoiceTotal();
                    }

                    function calculateInvoiceTotal() {
                        let total = 0;
                        document.querySelectorAll('.item-quantity').forEach(input => {
                            total += (parseInt(input.value) || 0) * parseFloat(input.dataset.price);
                        });
                        document.getElementById('invoiceTotal').textContent = 'R ' + total.toFixed(2);
                    }

                    // Set default dates for reports if modal opens
                    const reportModal = document.getElementById('Report-modal');
                    if (reportModal) {
                        reportModal.addEventListener('show.bs.modal', event => {
                            const today = new Date().toISOString().split('T')[0];
                            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                            const inputs = reportModal.querySelectorAll('input[type="date"]');
                            if (inputs.length === 2) {
                                if (!inputs[0].value) inputs[0].value = firstDay;
                                if (!inputs[1].value) inputs[1].value = today;
                            }
                        });
                    }
                </script>
                

{% endblock %}
